window.wp=window.wp||{},window.bp=window.bp||{},function(t,e){"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau=bp.Nouveau||{},bp.Nouveau.ActivityReaction={start:function(){this.views=new Backbone.Collection,this.collections=[],this.types=[],this.fetchXhr=null,this.loader=[],this.loader_html=e('<p class="reaction-loader"><i class="bb-icon-l bb-icon-spinner animate-spin"></i></p>'),this.addListeners(),this.Initialize()},addListeners:function(){e(document).on("click",".activity-state-reactions",this.showActivityReactions)},Initialize:function(){},showActivityReactions:function(t){t.preventDefault();var i=bp.Nouveau.ActivityReaction,a=e(t.currentTarget),o=a.next(".activity-state-popup"),n=0,s="";0<a.parents(".acomment-display").first().length?(n=a.parents(".activity-comment").first().data("bp-activity-comment-id").toString(),s="activity_comment"):(n=a.parents(".activity-item").data("bp-activity-id").toString(),s="activity");var c=n+"_0";o.find("#reaction-content-"+n+" .reaction-loader").remove(),o.find("#reaction-content-"+n+" .activity_reaction_popup_error").remove(),""===e.trim(o.find("#reaction-content-"+n).html())&&(i.collections[c]=new bp.Collections.ActivityReactionCollection,i.loader[n]=new bp.Views.ReactionPopup({collection:i.collections[c],item_id:n,targetElement:o.find("#reaction-content-"+n),item_type:s})),o.show()}},bp.Models.reactedItems=Backbone.Model.extend({}),bp.Collections.ActivityReactionCollection=Backbone.Collection.extend({model:bp.Models.reactedItems,options:{},per_page:20,this:this,url:BP_Nouveau.ajaxurl,initialize:function(){this.options={page:1,per_page:this.per_page,item_type:"activity"}},sync:function(t,e,i){null!==bp.Nouveau.ActivityReaction.fetchXhr&&bp.Nouveau.ActivityReaction.fetchXhr.abort();var a=this;return i=i||{},i.context=a,i.data=i.data||{},_.extend(i.data,_.pick(a.options,["page","per_page","before"])),i.path=BP_Nouveau.ajaxurl,i.method="POST",i.data._wpnonce=BP_Nouveau.nonces.activity,i.data.action="bb_get_reactions",bp.Nouveau.ActivityReaction.fetchXhr=Backbone.sync(t,e,i),bp.Nouveau.ActivityReaction.fetchXhr},parse:function(t){var e=t.success?t.data:{};return _.isUndefined(e.reacted_users)?{}:e.reacted_users}}),bp.Views.ReactionPopup=Backbone.View.extend({tagName:"div",className:"",template:bp.template("activity-reacted-popup-loader"),targetElement:"",options:{},initialize:function(t){this.loader=bp.Nouveau.ActivityReaction.loader_html,this.options=t,this.targetElement=t.targetElement,this.targetElement.append(this.loader),this.collection.fetch({data:_.pick(t,["page","per_page","item_id","item_type"]),success:_.bind(this.onOpenSuccessRender,this),error:_.bind(this.onOpenFailedRender,this)})},onOpenSuccessRender:function(t,i,a){if(this.loader.remove(),i.success){var o={collection:this.options.collection,item_id:this.options.item_id,item_type:this.options.item_type,model:this.collection.toJSON(),data:i.success?i.data:{}},n=new bp.Views.ReactionPopupHeading(o);this.targetElement.append(n.render().el);var s=new bp.Views.ReactionPopupContent(o);if(this.targetElement.append(s.render().el),this.targetElement.find(".activity-state-popup_tab_item > ul")){var c=this;this.targetElement.find(".activity-state-popup_tab_item > ul").each(function(){e(this).on("scroll",_.bind(c.onScrollLoadMore,c))})}}else this.onOpenFailedRender(t,i,a);return this},onOpenFailedRender:function(t,e,i){if(this.loader.remove(),void 0===e.statusText||"abort"!==e.statusText){var a={collection:i.collection,data:e.success?{}:e.data};this.targetElement.find(".activity_reaction_popup_error").remove();var o=new bp.Views.ReactionErrorHandle(a);this.targetElement.append(o.render().el)}},onScrollLoadMore:function(t){var i=t.currentTarget,a=e(i);if(!e(i).hasClass("loading")){var o=i.scrollHeight-a.scrollTop()-a.outerHeight(),n=10,s=a.parents(".activity-state-popup_tab_item").attr("data-reaction-id"),c=parseInt(a.parents(".activity-state-popup_tab_item").attr("data-total-pages")),p=a.parents(".activity-state-popup_tab_item").attr("data-paged");if(void 0===p&&(p=1),o<=n&&p<c&&!e(i).hasClass("loading")){0===a.parents(".activity-state-popup_tab_item").find(".reaction-loader").length?a.parents(".activity-state-popup_tab_item").append(this.loader.show()):a.parents(".activity-state-popup_tab_item").find(".reaction-loader").show(),e(i).addClass("loading"),p=parseInt(p,10)+1;var arguments={item_id:this.options.item_id,item_type:this.options.item_type,reaction_id:s,page:p},r=arguments.item_id+"_"+arguments.reaction_id;void 0===bp.Nouveau.ActivityReaction.collections[r]&&(bp.Nouveau.ActivityReaction.collections[r]=new bp.Collections.ActivityReactionCollection),this.collection=bp.Nouveau.ActivityReaction.collections[r],this.args={collection:this.options.collection,item_id:this.options.item_id,item_type:this.options.item_type,model:this.collection.toJSON()},this.collection.length>0&&(arguments.before=this.collection.last().get("id")),_.extend(this.collection.options,_.pick(arguments,["page","item_id","item_type","reaction_id","before"])),this.args.collection=this.collection,this.collection.fetch({data:_.pick(arguments,["page","item_id","item_type","reaction_id"]),success:_.bind(this.onLoadMoreSuccessRender,this,a),error:_.bind(this.onLoadMoreFailedRender,this,a)})}}},onLoadMoreSuccessRender:function(t,e,i){if(this.loader.remove(),i.success){var a=this.collection.toJSON(),o=i.success&&!_.isUndefined(i.data.page)?i.data.page:0;0!==o&&t.parents(".activity-state-popup_tab_item").attr("data-paged",o),_.each(a,function(e){var i=new bp.Views.ReactionItem({model:e});t.append(i.render().el)}),t.removeClass("loading")}else this.onLoadMoreFailedRender(t,e,i);return this},onLoadMoreFailedRender:function(t,e,i){if(this.loader.remove(),void 0===i.statusText||"abort"!==i.statusText){var a={data:i.success?{}:i.data};t.find(".activity_reaction_popup_error").remove();var o=new bp.Views.ReactionErrorHandle(a);t.append(o.render().el)}}}),bp.Views.ReactionPopupHeading=Backbone.View.extend({tagName:"div",className:"activity-state-popup_title",template:bp.template("activity-reacted-popup-heading"),initialize:function(t){this.data=t.data},render:function(){return this.$el.html(this.template(this.data)),this}}),bp.Views.ReactionPopupContent=Backbone.View.extend({tagName:"div",template:_.template(""),className:"activity-state-popup_tab",options:{},initialize:function(t){this.options=t,this.data=t.data},render:function(){var t={collection:this.options.collection,item_id:this.options.item_id,item_type:this.options.item_type,model:this.model,data:this.data},e=new bp.Views.ReactionPopupTabs(t);this.$el.append(e.render().el);var i=new bp.Views.ReactionPopupLists(t);return this.$el.append(i.render().el),this}}),bp.Views.ReactionPopupTabs=Backbone.View.extend({tagName:"div",className:"activity-state-popup_tab_panel",template:bp.template("activity-reacted-popup-tab"),model:this.model,options:{},collection:{},initialize:function(t){this.loader=bp.Nouveau.ActivityReaction.loader_html,this.options=t,this.collection=t.collection,this.$el.on("click","li > a",_.bind(this.LoadTabData,this)),this.args={collection:this.options.collection,item_id:this.options.item_id,item_type:this.options.item_type,model:this.model}},render:function(){return this.$el.html(this.template(this.options.data)),this},LoadTabData:function(t){var i=e(t.currentTarget),a=i.data("tab"),o=i.parents(".activity-state-popup_tab").find("."+a);if(0<o.length){if(0!==o.find(".activity-state_users li").length)return;o.find(".activity_reaction_popup_error").remove(),o.append(this.loader.show());var arguments={item_id:this.options.item_id,item_type:this.options.item_type,reaction_id:o.data("reaction-id"),page:o.data("paged")},n=arguments.item_id+"_"+arguments.reaction_id;void 0===bp.Nouveau.ActivityReaction.collections[n]&&(bp.Nouveau.ActivityReaction.collections[n]=new bp.Collections.ActivityReactionCollection),this.collection=bp.Nouveau.ActivityReaction.collections[n],this.args.collection=this.collection,this.collection.fetch({data:_.pick(arguments,["page","per_page","item_id","item_type","reaction_id"]),success:_.bind(this.onTabChangeSuccessRender,this,o),error:_.bind(this.onTabChangeFailedRender,this,o)})}},onTabChangeSuccessRender:function(t,e,i){if(t.find(".reaction-loader")&&t.find(".reaction-loader").remove(),i.success){var a=this.collection.toJSON();_.each(a,function(e){var i=new bp.Views.ReactionItem({model:e});t.find(".activity-state_users").append(i.render().el)})}else this.onTabChangeFailedRender(t,e,i);return this},onTabChangeFailedRender:function(t,e,i){if(t.find(".reaction-loader")&&t.find(".reaction-loader").remove(),void 0===i.statusText||"abort"!==i.statusText){var a={data:i.success?{}:i.data};t.find(".activity_reaction_popup_error").remove();var o=new bp.Views.ReactionErrorHandle(a);t.append(o.render().el)}}}),bp.Views.ReactionPopupLists=Backbone.View.extend({tagName:"div",className:"activity-state-popup_tab_content",template:bp.template("activity-reacted-popup-tab-content"),initialize:function(t){this.options=t,this.data=t.data},render:function(){return this.$el.html(this.template(this.data)),this}}),bp.Views.ReactionItem=Backbone.View.extend({tagName:"li",className:"activity-state_user",template:bp.template("activity-reacted-item"),render:function(){return this.$el.html(this.template(this.model)),this}}),bp.Views.ReactionErrorHandle=Backbone.View.extend({tagName:"div",className:"activity_reaction_popup_error",template:bp.template("activity-reacted-no-data"),initialize:function(t){this.data=t.data},render:function(){var t=this.data;return(void 0===t.message||0>=t.message.length)&&(t.message=BP_Nouveau.activity.strings.reactionAjaxError),this.$el.html(this.template(t)),this}}),bp.Nouveau.ActivityReaction.start())}(bp,jQuery);