window.wp=window.wp||{},window.bp=window.bp||{},function(i,t){"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau=bp.Nouveau||{},bp.Nouveau.Subscriptions={start:function(){this.views=new Backbone.Collection,this.subscriptions=[],this.types=[],this.fetchXhr=[],this.addListeners(),this.Initialize()},addListeners:function(){},Initialize:function(){this.types=t(".subscription-views .bb-accordion");var i=[],e=this;this.types.length>0&&_.each(this.types,(function(s){var o=t(s).data("type");if(""!==o){this.subscriptions[o]=new bp.Collections.Subscriptions,i[o]=new bp.Views.SubscriptionItems({collection:this.subscriptions[o],type:o}),e.views.add({id:"subscriptions_"+o,view:i[o]});var n=t(s).find(".bb-accordion_panel").get(0);i[o].inject(n)}}))}},bp.Models.subscriptionItem=Backbone.Model.extend({defaults:{id:0,user_id:0,type:"0",item_id:0,secondary_item_id:"",date_recorded:"",_embedded:{}}}),bp.Collections.Subscriptions=Backbone.Collection.extend({model:bp.Models.subscriptionItem,options:{},subscription_items:null,per_page:BP_Nouveau.subscriptions.per_page,initialize:function(){this.options={page:1,per_page:this.per_page,total_pages:1}},sync:function(i,t,e){var s=this;(e=e||{}).context=this,e.data=e.data||{},e.path="buddyboss/v1/subscriptions",e.method="GET",e.data=_.extend(e.data,s.options);var o="",n=_.pick(e.data,["type"]);return _.isUndefined(n.type)||(o=n.type),bp.Nouveau.Subscriptions.fetchXhr[o]=bp.apiRequest(e).done((function(i,t,e){s.options.total_pages=e.getResponseHeader("x-wp-totalpages"),s.subscription_items=i})).fail((function(i){s.subscription_items=i})),this.subscription_items},parse:function(i){return i}}),bp.Nouveau.Subscriptions.View=bp.Backbone.View.extend({inject:function(i){this.render(),t(i).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),bp.Views.SubscriptionItems=bp.Nouveau.Subscriptions.View.extend({tagName:"div",className:"subscription-items-main",events:{"click .subscription-item_remove":"removeSubscription","click a.prev":"gotoPage","click a.page":"gotoPage","click a.next":"gotoPage"},loader:!1,ul_view:!1,pagination_params:{total_page:0,current_active:1},is_delete_request:!1,initialize:function(){var i=this.getSubscriptionType();this.loader=new bp.Views.SubscriptionLoading,this.views.add(this.loader),this.requestSubscriptions(),this.ul_view=[new bp.Nouveau.Subscriptions.View({tagName:"ul",id:"subscription-items-"+i,className:"subscription-items"})],_.each(this.ul_view,(function(i){this.views.add(i)}),this),this.collection.on("add",this.addThread,this),this.collection.on("reset",this.cleanContent,this)},requestSubscriptions:function(i){i=void 0!==i&&i,!0!==(i=void 0!==this.collection.hideLoader&&!1!==this.collection.hideLoader?this.collection.hideLoader:i)?this.collection.reset():(this.collection.models=[],this.collection.length=0,this.collection.options={},this.collection._byId=[],this.collection.hideLoader=i),!_.isUndefined(bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()])&&null!==bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()]&&_.has(bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()],"state")&&"resolved"!==bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()].state()&&bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()].abort(),this.collection.fetch({data:_.pick(this.options,["type","page","per_page"]),success:_.bind(this.subscriptionFetched,this),error:_.bind(this.subscriptionFetchError,this)})},addThread:function(i){this.views.add(".subscription-items",new bp.Views.SubscriptionItem({item:i.attributes}))},cleanContent:function(){_.each(this.views._views[".subscription-items"],(function(i){i.remove()}));var i=this.getSubscriptionType();i&&t("#subscription-items-"+i).html("")},subscriptionFetched:function(){this.loader&&this.loader.remove();var i=this;this.cleanPagination(),setTimeout((function(){1>i.collection.length&&i.addNoSubscriptionView(i.options.type),i.collection.options.total_pages>1&&(i.getPaginationParams(),i.views.add(new bp.Views.SubscriptionPager({options:i.pagination_params}),{at:1}))}),100)},cleanPagination:function(){_.each(this.views._views,(function(i){_.isUndefined(i)||_.each(i,(function(i){_.isUndefined(i)||"subscription-pagination"!==i.el.id||i.remove()}))}))},getPaginationParams:function(){var i=this,t=1;return void 0!==i.collection.options.current_active&&(t=i.collection.options.current_active),i.pagination_params={total_page:parseInt(i.collection.options.total_pages),current_active:parseInt(t)},i.pagination_params},subscriptionFetchError:function(){this.loader&&this.loader.remove()},removeSubscription:function(i){var e=t(i.currentTarget),s=e.data("subscription-id"),o=this;if(!s)return i;i.preventDefault();var n={};n.path="buddyboss/v1/subscriptions/"+s,n.method="DELETE",n.data={type:o.options.type,page:o.collection.options.page,per_page:o.collection.options.per_page,total_pages:o.collection.options.total_pages};var a=e.parents(".bb-subscription-item").find(".subscription-item_title").text();25<a.length?a=a.substring(0,25)+"...":a+=".",e.addClass("is_loading"),bp.apiRequest(n).done((function(i){_.isUndefined(i.deleted)?(e.removeClass("is_loading"),jQuery(document).trigger("bb_trigger_toast_message",["","<div>"+BP_Nouveau.subscriptions.error+"<strong>"+a+"</strong></div>","error",null,!0])):(jQuery(document).trigger("bb_trigger_toast_message",["","<div>"+BP_Nouveau.subscriptions.unsubscribe+"<strong>"+a+"</strong></div>","info",null,!0]),_.isUndefined(i.page)?o.getSubscriptionByPage(1):o.getSubscriptionByPage(i.page))})).fail((function(){jQuery(document).trigger("bb_trigger_toast_message",["","<div>"+BP_Nouveau.subscriptions.error+"<strong>"+a+"</strong>.</div>","error",null,!0]),e.removeClass("is_loading")}))},gotoPage:function(i){var e=t(i.currentTarget).data("page");if(!e)return i;i.preventDefault(),this.getSubscriptionByPage(e)},getSubscriptionByPage:function(i){_.isUndefined(bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()])||null===bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()]||"resolved"===bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()].state()||bp.Nouveau.Subscriptions.fetchXhr[this.getSubscriptionType()].abort(),this.collection.reset(),this.cleanPagination(),_.isUndefined(this.views.get(this.loader))&&this.views.add(this.loader),this.collection.options.page=i,this.collection.options.current_active=i,this.collection.fetch({data:_.pick(this.options,["type","page","per_page"]),success:_.bind(this.subscriptionFetched,this),error:_.bind(this.subscriptionFetchError,this)})},addNoSubscriptionView:function(i){_.each(this.views._views,(function(i){_.isUndefined(_.first(i))||_.first(i).remove()}));var e=t(".bb-accordion[data-type="+i+"]"),s=e.data("singular-label"),o=e.data("plural-label");this.views.add(new bp.Views.MemberNoSubscription({singularLabel:s.toLowerCase(),pluralLabel:o.toLowerCase()}))},getSubscriptionType:function(){var i=_.pick(this.options,"type");return!_.isUndefined(i.type)&&i.type}}),bp.Views.SubscriptionItem=bp.Nouveau.Subscriptions.View.extend({tagName:"li",className:"bb-subscription-item",template:bp.template("bb-subscription-item"),initialize:function(){this.model=new Backbone.Model({item:this.options.item})}}),bp.Views.SubscriptionLoading=bp.Nouveau.Subscriptions.View.extend({tagName:"div",className:"",template:bp.template("bb-member-subscription-loading")}),bp.Views.SubscriptionPager=bp.Nouveau.Subscriptions.View.extend({tagName:"div",id:"subscription-pagination",className:"bbp-pagination subscription-pagination",template:bp.template("bb-member-subscription-pagination"),initialize:function(){this.model=new Backbone.Model({options:this.options})}}),bp.Views.MemberNoSubscription=bp.Nouveau.Subscriptions.View.extend({tagName:"div",className:"subscription-items",template:bp.template("bb-member-no-subscription"),initialize:function(){this.model=new Backbone.Model({singularLabel:this.options.singularLabel,pluralLabel:this.options.pluralLabel})}}),bp.Nouveau.Subscriptions.start())}(bp,jQuery);
